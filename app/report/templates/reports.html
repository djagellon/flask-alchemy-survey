{% extends 'home.html' %}

{% macro admin_data(answer, action) %}
  <span class="admin report-footer">
    <span class="label label-default">{{answer.datalabel}}</span>
    <span class="label label-default">{{action}}</span>

    {% if answer.weight %}
      <span class="label label-default">weight:{{answer.weight}}</span>
      <span class="label label-default">score:{{answer.score}}</span>
    {% endif %}

    {% if answer.notes %}
      <span><em>{{answer.notes}}</em></span>
    {% endif %}
  </span>
{% endmacro %}

{% block header %}
  <h1>{% block title %}Report{% endblock %}</h1>
{% endblock %}

{% block content %}
  <h3> {{module.capitalize()}} - Overall Score 
    <span class="label label-default score-{{grade}}">{{score}}</span>
  </h3> 

<div class="panel-group" id="accordion" aria-multiselectable="true">
  {% for answer in data %}
    {% if answer.actions %}
      {% for action in answer.actions %}
        {% set status = answer.actions[action]['complete']%}
        {% set collapse_label = action.replace('.', '_') %}
        <div class="panel panel-default" role="tab" data-answer="{{action}}" id="heading_{{collapse_label}}">
          <div class="panel-body">
            <div class="row">
              <div class="col-md-11">
                {{ answer.actions[action]['plan'] | nl2br }}
              </div>
              <div class="col-md-1 text-center">
                <div class="row">
                  <button 
                    data-status="{{ status }}" 
                    class="mark-complete btn btn-xs {{'btn-success' if status else 'btn-warning'}}">
                    {{ 'Complete' if status else 'Incomplete' }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="collapse_{{collapse_label}}" role="tabpanel" aria-labeledby="heading_{{collapse_label}}" class="panel-collapse collapse">
            <div class="panel-body">
              {% if answer['short'] %}
                <div class="short_output">
                  {{answer['short'] | nl2br}}
                </div>
              {% endif %}
              {% if answer['long']%}
                <div class="long_output">
                  <br/>
                  {{answer['long'] | nl2br}}
                </div>
              {% endif %}
            </div>
          </div>

          <div id="collapse_how{{collapse_label}}" role="tabpanel" aria-labeledby="heading_{{collapse_label}}" class="panel-collapse collapse">
            <div class="panel-body">
              {% if answer.actions[action]['how'] %}
                <div class="how_output">
                  {{ answer.actions[action]['how'] | nl2br }}
                </div>
              {% endif %}
            </div>
          </div>

          <div id="collapse_video{{collapse_label}}" role="tabpanel" aria-labeledby="heading_{{collapse_label}}" class="panel-collapse collapse">
            <div class="panel-body">
              <div class="embed-responsive embed-responsive-4by3">
                <iframe class="embed-responsive-item" src="{{ answer.actions[action]['video'] }}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
              </div> 
            </div>
          </div>

          <div class="panel-footer">
            <span class="expand_footer_text"> 
              {% if answer['short'] or answer['long'] %}

                <button 
                  class="show-why btn btn-primary btn-xs"
                  data-toggle="collapse" 
                  data-parent="#accordion" 
                  href="#collapse_{{collapse_label}}" 
                  aria-expanded="false" 
                  aria-controls="collapse_{{collapse_label}}">
                  <span class="why_collapsed">
                    Show Me Why
                  </span>
                  <span class="why_expanded">
                    Hide Why
                  </span> 
                </button>

              {% endif %}

              {% if answer.actions[action]['how'] %}

                <button 
                  class="show-how btn btn-primary btn-xs"
                  data-toggle="collapse" 
                  data-parent="#accordion" 
                  href="#collapse_how{{collapse_label}}" 
                  aria-expanded="false" 
                  aria-controls="collapse_how{{collapse_label}}">
                  <span class="how_collapsed">
                    Show Me How
                  </span>
                  <span class="how_expanded">
                    Hide How
                  </span> 
                </button>

              {% endif %}

              {% if answer.actions[action]['video'] %}
                <button 
                  class="show-how btn btn-primary btn-xs"
                  data-toggle="collapse" 
                  data-parent="#accordion" 
                  href="#collapse_video{{collapse_label}}" 
                  aria-expanded="false" 
                  aria-controls="collapse_video{{collapse_label}}">
                  <i class="glyphicon glyphicon-facetime-video"></i>
                </button>
              {% endif %}

            </span>

            <div>
              {% if current_user.is_admin and current_user.admin_controls_on %}
                {{admin_data(answer, action)}}
              {% endif %}
            </div>

          </div>
        </div>
      {% endfor%}
    {% endif %}
  {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
  {{super()}}
  <script type="text/javascript" src="https://cdn.datatables.net/v/bs/dt-1.10.18/datatables.min.js"></script>
  <script type="text/javascript" src={{url_for("static", filename="js/report.js")}}></script>
{% endblock %}
